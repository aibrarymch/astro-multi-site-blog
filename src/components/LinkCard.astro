---
import type { OgData } from '../utils/fetchOgData';
import { fetchOgData } from '../utils/fetchOgData';

interface Props {
  url: string;
  title?: string;
  description?: string;
  image?: string;
  imageFit?: 'cover' | 'contain'; // SP表示時は常に `cover` になります
  noImage?: boolean;
}

const props = Astro.props as Props;
if (!props.url) {
  throw new Error('LinkCard requires a `url` prop.');
}

let baseUrl = props.url;
try {
  baseUrl = new URL(props.url).toString();
} catch {
  throw new Error(`LinkCard received an invalid URL: ${props.url}`);
}

let fetched: OgData | undefined;
if (!props.title || !props.description || !props.image) {
  fetched = await fetchOgData(baseUrl);
}

const isFailed = fetched?.failed ?? false;
const finalTitle = props.title ?? fetched?.title ?? baseUrl;
const finalDescription = props.description ?? fetched?.description;
// ローカルにキャッシュされた画像を優先、なければ外部URLを使用
const finalImage = props.image ?? fetched?.localImage ?? fetched?.image;
const imageFit = props.imageFit ?? 'cover';
const noImage = props.noImage || !finalImage;
const favicon = fetched?.favicon;
---
{isFailed ? (
  <div class="blog-card failed no-image">
    <div class="content">
      <span class="failed-badge">ページを取得できませんでした</span>
      <span class="link-info">
        <span class="link-url">{baseUrl}</span>
      </span>
    </div>
  </div>
) : (
  <a class={`blog-card${noImage ? ' no-image' : ''}`} href={baseUrl} target="_blank" rel="noopener noreferrer">
    {!noImage && finalImage ? (
      <div class={`thumbnail fit-${imageFit}`}>
        <img src={finalImage} alt={finalTitle} loading="lazy" decoding="async" />
      </div>
    ) : null}
    <div class="content">
      <h3>{finalTitle}</h3>
      {finalDescription ? <p>{finalDescription}</p> : null}
      <span class="link-info">
        {favicon ? (
          <img class="favicon" src={favicon} alt="" loading="lazy" decoding="async" />
        ) : null}
        <span class="link-url">{baseUrl}</span>
      </span>
    </div>
  </a>
)}

<style>
  .blog-card {
    margin: 28px 0;
    display: grid;
    grid-template-columns: minmax(0, 1fr) 160px;
    gap: 0;
    align-items: stretch;
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    background: var(--bg-card);
    text-decoration: none;
    color: inherit;
    overflow: hidden;
    transition: border-color 0.18s ease;
  }

  .blog-card.no-image {
    grid-template-columns: 1fr;
  }

  .blog-card:not(.failed):hover {
    border-color: var(--accent);
  }

  .blog-card.failed {
    border-style: dashed;
    opacity: 0.7;
    cursor: default;
  }

  .failed-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .failed-badge::before {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    background-color: var(--text-secondary);
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E");
    mask-size: contain;
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E");
    -webkit-mask-size: contain;
    flex-shrink: 0;
  }

  .thumbnail {
    position: relative;
    order: 1;
    width: 160px;
    height: 160px;
    background: var(--bg-thumb);
  }

  .thumbnail img {
    width: 100%;
    height: 100%;
    display: block;
    object-position: center;
  }

  .fit-cover img {
    object-fit: cover;
  }

  .fit-contain img {
    object-fit: contain;
  }
  @media (max-width: 720px) {
    .fit-contain img {
      object-fit: cover;
    }
  }

  .content {
    padding: 18px;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .favicon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--bg-favicon);
    padding: 2px;
  }

  h3 {
    margin: 0;
    font-size: 1rem;
    color: var(--text-primary);
    line-height: 1.4;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
  }

  p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.6;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .link-info {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
    color: var(--accent);
    margin-top: auto;
    word-break: break-all;
  }

  .link-url {
    display: inline-block;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @media (max-width: 720px) {
    .blog-card {
      grid-template-columns: 1fr;
    }

    .content {
      padding: 14px 18px 18px 18px;
    }

    h3 {
      -webkit-line-clamp: 2;
    }

    .thumbnail {
      order: 0;
      width: 100%;
      height: 180px;
    }
  }
</style>
